name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  merge_group:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pre-commit:
    name: Pre-commit
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'
          cache: 'pip'
          cache-dependency-path: '.pre-commit-config.yaml'
      - name: Cache pre-commit
        uses: actions/cache@v5
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
      - name: Run pre-commit
        uses: pre-commit/action@v3.0.1

  lint:
    name: Chart Lint
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'merge_group'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0
      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.6.1
      - name: Run chart-testing (lint)
        run: ct lint --config ct.yaml --charts .

  kubeconform:
    name: Kubeconform
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'merge_group'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0
      - name: Run kubeconform
        run: |
          helm dependency build
          helm template . --namespace kuack-system |
            docker run --rm -i ghcr.io/yannh/kubeconform:latest-alpine \
              -summary -output pretty \
              -schema-location default \
              -schema-location "https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json" \
              -

  checkov:
    name: Checkov
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' # only run on PRs
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0
      - name: Build chart dependencies
        run: helm dependency build
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        env:
          HELM_NAMESPACE: kuack-system
        with:
          directory: .
          framework: helm
          config_file: .checkovignore.yaml
          quiet: true
          output_format: cli

  trivy:
    name: Trivy
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' # only run on PRs
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
        env:
          TRIVY_IGNOREFILE: .trivyignore.yaml

  ci-passed:
    name: CI Passed
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request' # only run on PRs
    needs: [pre-commit, lint, kubeconform, checkov, trivy]
    steps:
      - name: Check status of all required jobs
        run: |
          echo "Results: ${{ toJson(needs) }}"
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" || "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more jobs failed or were cancelled"
            exit 1
          fi
          if [[ "${{ contains(needs.*.result, 'skipped') }}" == "true" ]]; then
            echo "One or more jobs were skipped, but strictly required"
            exit 1
          fi
          echo "All required checks passed"
